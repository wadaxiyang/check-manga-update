name: check

on:
  # å®šæ—¶è§¦å‘
  schedule:
    # æ¯éš”30åˆ†é’Ÿè§¦å‘ä¸€æ¬¡
    - cron: "*/30 * * * *"
    # æ¯å°æ—¶æ•´ç‚¹è§¦å‘
    # - cron: "0 * * * *"

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-get-update:
    runs-on: ubuntu-latest

    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v3

    # è®¾ç½® Python çŽ¯å¢ƒ
    - name: è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: 3.x  # æ›¿æ¢ä¸ºä½ çš„ Python ç‰ˆæœ¬

    # å®‰è£… requirements.txt ä¸­çš„ä¾èµ–
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

      # 2. åŠ¨æ€ç”Ÿæˆ var.json æ–‡ä»¶
    - name: Generate var.json
      run: |
          echo '{
            "token": "'"${{ secrets.TOKEN }}"'",
            "username": "'"${{ secrets.USERNAME }}"'",
            "password": "'"${{ secrets.PASSWORD }}"'",
            "from_email": "'"${{ secrets.FROM_EMAIL }}"'",
            "to_email": "'"${{ secrets.TO_EMAIL }}"'",
            "email_token": "'"${{ secrets.EMAIL_TOKEN }}"'"
          }' > data/var.json

    # æ£€æŸ¥æ¼«ç”»æ›´æ–°
    - name: æ£€æŸ¥æ›´æ–°
      run: |
        python main.py

    # æ›´æ–° comics.json
    - name: æ›´æ–°æ¼«ç”»å†…å®¹
      run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          cd data
          git add comics.json
          if git diff-index --quiet HEAD --; then
            echo "No changes to commit"
          else
            git commit -m 'ðŸ“ƒ docs: æ¼«ç”»å†…å®¹æ›´æ–°'
            git push
          fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
